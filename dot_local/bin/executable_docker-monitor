#!/bin/bash

# Monitor de uso de Docker para Colima
# Alerta cuando el uso supera el 80% del límite configurado (3GB)
# Uso: docker-monitor

# Configuración
LIMIT_GB=3
WARNING_PERCENT=80
LIMIT_BYTES=$((LIMIT_GB * 1024 * 1024 * 1024))
WARNING_BYTES=$((LIMIT_BYTES * WARNING_PERCENT / 100))

# Colores para salida en terminal
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Función para convertir bytes a GB human-readable
bytes_to_gb() {
    local bytes=$1
    echo "scale=2; $bytes / 1024 / 1024 / 1024" | bc
}

# Función para obtener el uso total de Docker en bytes
get_docker_usage() {
    # Obtener uso de imágenes, contenedores, volúmenes y build cache
    local images=$(docker system df --format '{{.Size}}' 2>/dev/null | head -1)
    
    # Convertir a bytes (maneja formatos como GB, MB, etc.)
    local total_bytes=0
    
    # Calcular uso total del sistema Docker
    local system_df=$(docker system df --format '{{.Size}}' 2>/dev/null)
    
    # Parsear el tamaño total
    local total_size=$(echo "$system_df" | head -1)
    
    # Convertir a bytes
    if [[ $total_size =~ ^([0-9.]+)\s*(B|KB|MB|GB|TB)$ ]]; then
        local num=${BASH_REMATCH[1]}
        local unit=${BASH_REMATCH[2]}
        
        case $unit in
            B)   total_bytes=$(echo "$num" | awk '{print int($1)}') ;;
            KB)  total_bytes=$(echo "$num * 1024" | bc | awk '{print int($1)}') ;;
            MB)  total_bytes=$(echo "$num * 1024 * 1024" | bc | awk '{print int($1)}') ;;
            GB)  total_bytes=$(echo "$num * 1024 * 1024 * 1024" | bc | awk '{print int($1)}') ;;
            TB)  total_bytes=$(echo "$num * 1024 * 1024 * 1024 * 1024" | bc | awk '{print int($1)}') ;;
        esac
    fi
    
    echo $total_bytes
}

# Función para mostrar notificación nativa de macOS con botón
show_notification() {
    local current_gb=$1
    local limit_gb=$2
    local warning_gb=$3
    
    # Usar osascript para mostrar alerta con botón
    local result=$(osascript <<EOF
        display dialog "El uso de Docker ha alcanzado ${current_gb}GB de ${limit_gb}GB (límite: ${warning_gb}GB).\n\n¿Deseas limpiar ahora?" \
            buttons {"Más tarde", "Limpiar ahora"} \
            default button "Limpiar ahora" \
            with icon caution \
            with title "Docker Monitor - Uso Alto"
EOF
)
    
    # Verificar qué botón se presionó
    if [[ $result == *"Limpiar ahora"* ]]; then
        return 0
    else
        return 1
    fi
}

# Función principal de monitoreo
monitor() {
    # Verificar si Docker/Colima está corriendo
    if ! docker info >/dev/null 2>&1; then
        echo -e "${YELLOW}[AVISO]${NC} Docker no está disponible. ¿Está Colima corriendo?"
        exit 0
    fi
    
    # Obtener uso actual
    local current_bytes=$(get_docker_usage)
    local current_gb=$(bytes_to_gb $current_bytes)
    local warning_gb=$(bytes_to_gb $WARNING_BYTES)
    
    echo -e "${BLUE}[INFO]${NC} Uso actual de Docker: ${current_gb}GB"
    echo -e "${BLUE}[INFO]${NC} Límite configurado: ${LIMIT_GB}GB"
    echo -e "${BLUE}[INFO]${NC} Umbral de advertencia (${WARNING_PERCENT}%): ${warning_gb}GB"
    
    # Verificar si supera el umbral
    if (( $(echo "$current_bytes > $WARNING_BYTES" | bc -l) )); then
        echo -e "${YELLOW}[ADVERTENCIA]${NC} Uso de Docker supera el ${WARNING_PERCENT}% del límite"
        
        # Mostrar notificación con botón
        if show_notification "$current_gb" "$LIMIT_GB" "$warning_gb"; then
            echo -e "${GREEN}[ACCION]${NC} Ejecutando limpieza..."
            docker-cleanup
        else
            echo -e "${YELLOW}[INFO]${NC} Limpieza pospuesta por el usuario"
        fi
    else
        echo -e "${GREEN}[OK]${NC} Uso de Docker dentro de límites normales"
    fi
}

# Si se ejecuta manualmente, mostrar información
if [[ "$1" == "--manual" || "$1" == "-m" ]]; then
    echo "======================================="
    echo "   Docker Monitor (Colima)"
    echo "======================================="
    echo ""
    monitor
    echo ""
    echo "======================================="
    echo "   Configuración Cron"
    echo "======================================="
    echo ""
    echo "Para ejecutar diariamente, agrega esto a tu crontab:"
    echo ""
    echo "0 9 * * * /Users/$USER/.local/bin/docker-monitor"
    echo ""
    echo "O usa: crontab -e"
    echo ""
elif [[ "$1" == "--install-cron" ]]; then
    # Instalar cronjob automáticamente
    (crontab -l 2>/dev/null; echo "0 9 * * * $HOME/.local/bin/docker-monitor") | crontab -
    echo -e "${GREEN}[OK]${NC} Cronjob instalado. Se ejecutará diariamente a las 9:00 AM"
    echo "Verifica con: crontab -l"
else
    # Ejecución silenciosa (para cron)
    monitor >/dev/null 2>&1
fi
